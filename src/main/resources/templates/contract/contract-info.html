<!DOCTYPE html>
<html class="x-admin-sm"  xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <title>欢迎页面-X-admin2.2</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <script src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/xadmin.js"></script>
    <style>
        /*.layui-card-header{*/
        /*    border:none;*/
        /*}*/
        .layui-card-header:first-child{
            border-bottom: 1px solid #f3f3f3;
        }
        .layui-card-body p{
            line-height: 32px;
            font-size: 14px;
            color: #333333;
            padding: 5px 0 ;
        }
        .layui-badge{
            background-color: transparent;
            width: 100px;
            margin-right: 10px;
            text-align:justify;
            text-justify:distribute-all-lines;/*ie6-8*/
            text-align-last:justify;/* ie9*/
            -moz-text-align-last:justify;/*ff*/
            -webkit-text-align-last:justify;/*chrome 20+*/
        }
    </style>
</head>
<body>
<div class="x-nav">
    <span class="layui-breadcrumb">
        <!--<a href="">首页</a>-->
        <!--<a href="">合同管理</a>-->
        <a>
            <cite>合同详细</cite></a>
    </span>
    <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
        <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
    </a>
    <!--<a class="layui-btn layui-btn-small layui-btn-normal" href="view?url=contract/contract-list.html" style="line-height:1.6em;margin-top:3px;float:right;margin-right: 15px">-->
        <!--<i class="layui-icon layui-icon-left" style="line-height:30px"></i>-->
        <!--返回-->
    <!--</a>-->
</div>
<!--合同主键-->
<input type="hidden" id="contractId">
<div class="layui-fluid">
    <shiro:hasPermission name="contractcost:contract:details:edit">
    <div class="layui-card-header">
        <button class="layui-btn layui-btn-normal" id="editContractInfo">
            <i class="layui-icon"></i>修改合同发票信息</button>
    </div>
    </shiro:hasPermission>
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">
                    合同详情
                </div>
                <div class="layui-card-header">
                    <div class="layui-col-md6 layui-col-xs12">
                        <span class="layui-badge layui-bg-blue">合同编号</span>
<!--                        <input type="text" name="contractNum" id="contractNum" lay-verify="title" autocomplete="off" placeholder="请输入合同编号" class="layui-input-inline">-->
                        <textarea style="height: 40px" type="text" name="contractNum" id="contractNum" lay-verify="title" autocomplete="off" placeholder="请输入合同编号" class="layui-input-inline"></textarea>
                        <!--TC-SC-2019-02-11-->
                    </div>
                    <div class="layui-col-md6 layui-col-xs12">
                        <span class="layui-badge layui-bg-blue">合同名称</span>
<!--                        <input type="text" name="contractName" id="contractName" lay-verify="required" lay-reqtext="" placeholder="请输入合同名称" autocomplete="off" class="layui-input-inline">-->
                        <textarea style="height: 40px" type="text" name="contractName" id="contractName" lay-verify="required" lay-reqtext="" placeholder="请输入合同名称" autocomplete="off" class="layui-input-inline"></textarea>
                        <!--廊坊市卫生填埋场项目-->
                    </div>
                </div>
                <div class="layui-card-header">
                    <div class="layui-col-md6 layui-col-xs12">
                        <span class="layui-badge layui-bg-blue">项目名称</span>
<!--                        <input type="text" name="itemName" id="itemName" lay-verify="required" lay-reqtext="" placeholder="请输入项目名称" autocomplete="off" class="layui-input-inline">-->
                        <textarea style="height: 40px" type="text" name="itemName" id="itemName" lay-verify="required" lay-reqtext="" placeholder="请输入项目名称" autocomplete="off" class="layui-input-inline"></textarea>
                        <!--廊坊市卫生填埋场项目-->
                    </div>
                    <div class="layui-col-md6 layui-col-xs12">
                        <span class="layui-badge layui-bg-blue">甲方单位</span>
<!--                        <input type="text" name="company" id="company" lay-verify="title" autocomplete="off" placeholder="请输入甲方单位" class="layui-input-inline">-->
                        <textarea style="height: 40px" type="text" name="company" id="company" lay-verify="title" autocomplete="off" placeholder="请输入甲方单位" class="layui-input-inline"></textarea>
                        <!--TC-SC-2019-02-11-->
                    </div>
                </div>
                <div class="layui-card-header">
                    <div class="layui-col-md6 layui-col-xs12">
                        <span class="layui-badge layui-bg-blue">项目经理</span>
                        <input type="text" name="itemManager" id="itemManager" lay-verify="required" lay-reqtext="" placeholder="请输入项目经理" autocomplete="off" class="layui-input-inline">
                        <!--廊坊市卫生填埋场项目-->
                    </div>
                </div>
                <div class="layui-card-header">
                    <div class="layui-col-md6 layui-col-xs12">
                        <span class="layui-badge layui-bg-blue">合同金额</span>
                        <input type="number" min="0" name="contractMoney" id="contractMoney" placeholder="￥" autocomplete="off" class="layui-input-inline">
                        <!--1252173-->
                    </div>
                    <div class="layui-col-md6 layui-col-xs12">
                        <span class="layui-badge layui-bg-blue">甲方联系人</span>
                        <input type="text" name="customer" id="customer" lay-verify="required" lay-reqtext="" placeholder="请输入客户名称" autocomplete="off" class="layui-input-inline">
                        <!--1214607.81-->
                    </div>
                </div>
                <div class="layui-card-body">
                     <p>
                         <span class="layui-badge layui-bg-blue">特殊说明</span>
                         <textarea placeholder="请输入内容" id="specialInstructions" name="specialInstructions" class="layui-textarea"></textarea>
                         <!--该项目设备由精工19万卖出至金源设备公司由腾达23万元购汇差额33500万元，因国家税率调整，甲方出具税率调整签证原合同金额1261000调整至1252137-->
                    </p>
                    <p>
                        <span class="layui-badge layui-bg-blue">质保金</span>
                        <textarea placeholder="请输入内容" name="premium" id="premium" class="layui-textarea"></textarea>
                        <!--剩余项目合同额3%未收回共计：37565.19元-->
                    </p>
                    <p>
                        <span class="layui-badge layui-bg-blue">项目结论</span>
                        <textarea placeholder="请输入内容" name="conclusion" id="conclusion" class="layui-textarea"></textarea>
                        <!--该项目总合同金额1252173元，其中销售提成275000元；提成税金24750元；金源与明收取314105元；-->
                        <!--施工及设备生产费为281352.64元；公司内管理费为总金额的20%计：250434.6元；该项目统计后利润为106530.76元。-->
                    </p>
                    <p>
                        <span class="layui-badge layui-bg-blue">状态</span>
                        <!--<b>-->
                        <select name="status" id="status">
                            <option value="1">未完成</option>
                            <option value="2">已完成</option>
                            <option value="0">已作废</option>
                        </select>
                        <!--<span id="status">-->
                            <!--&lt;!&ndash;已完成&ndash;&gt;-->
                        <!--</span>-->
                    <!--</b>-->
                    </p>
                </div>
            </div>
        </div>
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header">
                    开票信息
                </div>
                <div class="layui-card-header" style="height: 150px;">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">开户名称</span>
                        <textarea placeholder="请输入开户名称" id="accountName" name="accountName" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-card-header" style="height: 150px;">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">纳税人识别号</span>
                        <textarea placeholder="请输入纳税人识别号" id="tiNum" name="tiNum" class="layui-textarea"></textarea>
                        <input type="hidden" name="invoiceInfoId" id="invoiceInfoId" >
                    </div>
                </div>
                <div class="layui-card-header" style="height: 150px;">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">地点、电话</span>
                        <textarea placeholder="请输入地点、电话" id="placeOfOpening" name="placeOfOpening" class="layui-textarea"></textarea>
                    </div>
                </div>
                <!--<div class="layui-card-header">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">发票邮寄地址</span>
                        <textarea placeholder="请输入发票邮寄地址" id="mailingAddr" name="mailingAddr" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-card-header">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">联系电话</span>
                        <input type="text" name="tel" id="tel" lay-verify="required" lay-reqtext="" placeholder="请输入联系电话" autocomplete="off" class="layui-input-inline">
                    </div>
                </div>-->
                <div class="layui-card-header" style="height: 150px;">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">开户行及账号</span>
                        <textarea placeholder="请输入开户行及账号" id="openingBank" name="openingBank" class="layui-textarea"></textarea>
                    </div>
                </div>
                <!--<div class="layui-card-header">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">对公账号</span>
                        <input type="text" name="publicAccountNum" id="publicAccountNum" lay-verify="required" lay-reqtext="" placeholder="请输入对公账号" autocomplete="off" class="layui-input-inline">
                </div>
                </div>-->
                <!--<div class="layui-card-header">
                    <div class="layui-col-md12">
                        <span class="layui-badge layui-bg-green">联系人姓名</span>
                        <input type="text" name="contactName" id="contactName" lay-verify="required" lay-reqtext="" placeholder="请输入联系人姓名" autocomplete="off" class="layui-input-inline">
                    </div>
                </div>-->

            </div>
        </div>
        <div class="layui-col-md2">
            <div class="layui-card">
                <div class="layui-card-header">
                    附件下载
                </div>
                <div style="text-align: center;padding-bottom: 30px">
                    <img src="img/file.png">
                    <shiro:hasPermission name="contractcost:contract:details:download">
                        <button type="button" class="layui-btn" id="download"><i class="layui-icon layui-icon-download-circle"></i>下载文件</button>
                    </shiro:hasPermission>
                </div>
            </div>
        </div>
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    申请开票列表
                </div>
                <table class="layui-table layui-form" id="detailsTable" lay-filter="detailsTable">
                </table>
            </div>
        </div>
        <script type="text/html" id="barDemo">
            <shiro:hasPermission name="contractcost:contract:apply:download">
                <a class="layui-btn layui-btn-xs" lay-event="download">下载附件</a>
            </shiro:hasPermission>
            <shiro:hasPermission name="contractcost:contract:apply:edit">
                <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
            </shiro:hasPermission>
            <shiro:hasPermission name="contractcost:contract:apply:delete">
                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
            </shiro:hasPermission>
        </script>
    </div>
</div>
</body>
<script>
    function getData(params){
        layui.use(['laydate', 'table','form','jquery'],function() {
            var $ = layui.jquery,
                table = layui.table,
                form = layui.form;
            console.log(params)
            //查询合同发票信息
            $.ajax({
                url:"getInvoiceInfoByContractId"
                ,type:"post"
                ,data:{
                    id:params.id
                }
                ,async:"false"
                ,success:function(res){
                    if (res.success){
                        if(res.data != null){
                            $("#invoiceInfoId").val(res.data.id)
                            $("#tiNum").val(res.data.tiNum)
                            $("#accountName").val(res.data.accountName)
                            $("#publicAccountNum").val(res.data.publicAccountNum)
                            $("#openingBank").val(res.data.openingBank)
                            $("#placeOfOpening").val(res.data.placeOfOpening)
                            $("#mailingAddr").val(res.data.mailingAddr)
                            $("#contactName").val(res.data.contactName)
                            $("#tel").val(res.data.tel)
                        }else{
                            layer.msg("该合同无发票信息！",{icon:"5",time:1000})
                        }
                    }else{
                        layer.msg(res.msg,{icon:"5",time:1000})
                    }

                }
                ,error:function(){
                    layer.msg("系统错误！",{icon:"5",time:1000})
                }
            })

            var detailsTable = table.render({
                elem: '#detailsTable'
                ,id:'detailsTable'
                ,url: 'getApplyInvoiceInfoList' //数据接口
                ,method : 'post'
                ,page: true //开启分页
                ,where:{
                    id : params.id
                }
                ,limit : 10
                ,text:{
                    none:"暂无数据！"
                }
                ,cols: [
                    [
                        {field: 'name',align: 'center', title: '申请名称'}
                        ,{field: 'createUser',align: 'center', title: '创建人'}
                        ,{field: 'createtime',align: 'center', title: '申请日期', templet: function (d) {
                                return layui.util.toDateString(d.createtime, "yyyy-MM-dd")
                            }}
                        ,{field: 'latetime',align: 'center', title: '发票开具最迟时间', templet: function (d) {
                                return layui.util.toDateString(d.latetime, "yyyy-MM-dd")
                            }}
                        ,{field: 'type',align: 'center', title: '类型',templet:function (d) {
                            var stat;
                            if (d.type == "1"){
                                stat = "专票"
                            } else if(d.type == "2"){
                                stat = "普票"
                            }
                            return stat;
                        }}
                        ,{field: 'money',align: 'center', title: '金额'}
                        ,{field: 'note',align: 'center', title: '备注'}
                        ,{fixed:'right',title:'操作',align: 'center', width:'280',toolbar: '#barDemo'}
                    ]
                ]
                ,response: {
                    statusCode: 1 //重新规定成功的状态码为 200，table 组件默认为 0
                }
                ,parseData: function(res) { //将原始数据解析成 table 组件所规定的数据
                    return {
                        "code": res.code, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.data.total, //解析数据长度
                        "data": res.data.list //解析数据列表
                    }
                }
            });

            table.on('tool(detailsTable)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象
                if(obj.event == 'del'){
                    layer.confirm('确认要删除吗?', function(index){
                        $.ajax({
                            url: "deleteApplyInvoiceInfo/"+data.id,
                            dataType:"json",
                            type: "DELETE",
                            success: function(data){
                                if(data.success) {
                                    layer.msg(data.msg, {icon: 6,time: 1500},function () {
                                        table.reload('detailsTable');
                                        relodSubContractInfo();
                                    });
                                }else {
                                    layer.msg(data.msg,{icon:5,time:1000});
                                }
                            },
                            error : function(response){
                                layer.msg('系统错误！', {
                                    icon: 5
                                });
                            }
                        });
                    });
                } else if(obj.event == 'edit'){ //编辑
                    layer.open({
                        type: 2,
                        title: "修改其他成本信息",
                        closeBtn: 1,
                        content:'view?url=contract/applyInvoice-edit.html',
                        area: ['100%', '100%'],
                        btn: ['确定', '取消'],
                        shadeClose:true,
                        yes: function(index, layero) {
                            var submitID = 'edit',
                                submit = layero.find('iframe').contents().find('#' + submitID);
                            submit.trigger('click');
                        },
                        success: function (layero, index) {
                            var body = layer.getChildFrame('body', index);
                            console.log(data)
                            body.find("#id").val(data.id);
                            body.find("#name").val(data.name);
                            body.find("#createtime").val(layui.util.toDateString(data.createtime, "yyyy-MM-dd"));
                            body.find("#latetime").val(layui.util.toDateString(data.latetime, "yyyy-MM-dd"));
                            if (data.type == '1'){
                                body.find("#type1").attr("checked",'checked');
                            }
                            if (data.type == '2'){
                                body.find("#type2").attr("checked",'checked');
                            }
                            body.find("#money").val(data.money);
                            body.find("#note").val(data.note);
                        }
                    })
                }else if(layEvent === 'download'){
                    //根据开票主键查询
                    $.ajax({
                        url:"getApplyInvoiceEnclosureInfoById"
                        ,type:"post"
                        ,data:{
                            id:data.id
                        }
                        ,async:"false"
                        ,success:function(res){
                            if (res.success){
                                if(res.data.length == 0){
                                    layer.msg("该开票申请没有附件！",{icon:'5',time:'1000'})
                                }else{
                                    $.each(res.data,function (key,val) {
                                        // console.log(val.id+"  "+val.roomName)
                                        // console.log(key+"  "+val.filePath)
                                        //下载文件
                                        var fileName = val.filePath.substr(val.filePath.lastIndexOf("/")+1)
                                        var a = document.createElement('a');
                                        var evt = document.createEvent('HTMLEvents')
                                        var url = 'fileDownload?filePath='+val.filePath;
                                        evt.initEvent('click', false, false)
                                        a.href=url;
                                        a.dispatchEvent(evt);
                                        a.download = fileName;
                                        a.click()
                                    })
                                }
                            }
                        }
                        ,error:function(){
                            layer.msg("系统错误！",{icon:"5",time:1000})
                        }
                    })
                }
            });

            //修改合同信息
            $("#editContractInfo").on('click',function () {
                //查询合同发票信息
                $.ajax({
                    url:"editContractInfo"
                    ,type:"post"
                    ,data:{
                        id:params.id
                        ,contractNum:$("#contractNum").val()
                        ,contractName:$("#contractName").val()
                        ,itemName:$("#itemName").val()
                        ,itemManager:$("#itemManager").val()
                        ,company:$("#company").val()
                        ,contractMoney:$("#contractMoney").val()
                        ,customer:$("#customer").val()
                        ,specialInstructions:$("#specialInstructions").val()
                        ,premium:$("#premium").val()
                        ,conclusion:$("#conclusion").val()
                        ,status:$("#status").val()
                    }
                    ,async:"false"
                    ,success:function(res){
                        if (res.success){
                            layer.msg(res.msg,{icon:"6",time:1000},function () {
                                var flag = true
                                if ($.trim($("#tel").val()) != ""){
                                    var tel = $.trim($("#tel").val());
                                    var isMobile=/^(((13[0-9]{1})|(14[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1})|(19[0-9]{1}))+\d{8})$/
                                    if(!isMobile.test(tel)){
                                        flag = false
                                        layer.msg("开票联系电话格式有误",{icon:5,time:1000})
                                    };
                                }
                                if (flag){
                                    $.ajax({
                                        url:"editInvoiceInfo"
                                        ,type:"post"
                                        ,data:{
                                            id:$("#invoiceInfoId").val()
                                            ,tiNum:$("#tiNum").val()
                                            ,accountName:$("#accountName").val()
                                            ,publicAccountNum:$("#publicAccountNum").val()
                                            ,openingBank:$("#openingBank").val()
                                            ,placeOfOpening:$("#placeOfOpening").val()
                                            ,mailingAddr:$("#mailingAddr").val()
                                            ,contactName:$("#contactName").val()
                                            ,tel:$("#tel").val()
                                        }
                                        ,async:"false"
                                        ,success:function(result){
                                            if (res.success){
                                                layer.msg(result.msg,{icon:"6",time:1000})
                                            }else{
                                                layer.msg("发票修改失败",{icon:"5",time:1000})
                                            }
                                        }
                                        ,error:function(){
                                            layer.msg("系统错误！",{icon:"5",time:1000})
                                        }
                                    })
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭
                                    parent.layui.table.reload("contractTable");
                                }
                            })

                        }else {
                            layer.msg(res.msg,{icon:'5',time:'1500'})
                        }
                    }
                    ,error:function(){
                        layer.msg("系统错误！",{icon:"5",time:1000})
                    }
                })
            })

            //下载合同附件
            $("#download").on('click',function () {
                $.ajax({
                    url:"getEnclosureInfoByContractId"
                    ,type:"post"
                    ,data:{
                        id:params.id
                    }
                    ,async:"false"
                    ,success:function(res){
                        if (res.success){
                            if(res.data.length == 0){
                                layer.msg("该合同没有附件！",{icon:'5',time:'1000'})
                            }else{
                                $.each(res.data,function (key,val) {
                                    // console.log(val.id+"  "+val.roomName)
                                    // console.log(key+"  "+val.filePath)
                                    //下载文件
                                    var fileName = val.filePath.substr(val.filePath.lastIndexOf("/")+1)
                                    var a = document.createElement('a');
                                    var evt = document.createEvent('HTMLEvents')
                                    var url = 'fileDownload?filePath='+val.filePath;
                                    evt.initEvent('click', false, false)
                                    a.href=url;
                                    a.dispatchEvent(evt);
                                    a.download = fileName;
                                    a.click()
                                })
                            }
                        }
                    }
                    ,error:function(){
                        layer.msg("系统错误！",{icon:"5",time:1000})
                    }
                })
            })

        });


    }

</script>

</html>